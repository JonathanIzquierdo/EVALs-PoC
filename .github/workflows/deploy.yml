name: Deploy Product API

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: string
        default: 'staging'
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Start API server in background
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENAI_ENDPOINT: ${{ secrets.OPENAI_ENDPOINT }}
        OPENAI_DEPLOYMENT_ID: ${{ secrets.OPENAI_DEPLOYMENT_ID }}
        OPENAI_API_VERSION: ${{ secrets.OPENAI_API_VERSION }}
        OPENAI_TEMPERATURE: "0.9"
      run: |
        echo "Starting API server..."
        nohup python app.py > api.log 2>&1 &
        echo $! > api.pid
        sleep 15
        
    - name: Health check
      run: |
        echo "Checking API health..."
        max_attempts=10
        attempt=0
        while [ $attempt -lt $max_attempts ]; do
          if curl -f http://localhost:8000/health; then
            echo "✅ API is healthy"
            exit 0
          fi
          echo "Waiting for API... ($((attempt+1))/$max_attempts)"
          sleep 3
          attempt=$((attempt+1))
        done
        echo "❌ API health check failed"
        cat api.log
        exit 1
        
    - name: Show deployment info
      run: |
        echo "✅ Product API deployed successfully to ${{ inputs.environment }}"
        echo "Endpoint: http://localhost:8000"
        
    - name: Stop API server
      if: always()
      run: |
        if [ -f api.pid ]; then
          kill $(cat api.pid) || true
          rm api.pid
          echo "API server stopped"
        fi
